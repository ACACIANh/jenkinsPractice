pipeline {

    environment {
        imagename = "jenkins/hello-world:lts"
        registryUrl = "gkehdrn95ctl/jenkins-practice"
        registryCredentialId = "docker_hub_credentials"
        dockerImage = ''
    }
    agent any

	stages {
		stage("Checkout") {
			steps {
				checkout scm
			}
		}

		stage("Build jar") {
        	steps {
        	    echo 'Build jar'
                sh 'chmod +x gradlew'
                sh './gradlew clean build -b build.gradle'
        	}
        }

        stage("Build image") {
             steps {
                 script {
        	        echo 'Build image'

//                    sh 'docker build -t $imagename -f infra/Dockerfile .'
                    dockerImage = docker.build( imagename, "-f infra/Dockerfile ." )
                 }
             }
        }

        stage("Push image") {
             steps {
                 script {
        	        echo 'Push image'
        	        docker.withRegistry( registryUrl, registryCredentialId ) {
        	            dockerImage.push( 'latest' )
                    }
                 }
             }
        }

        stage("Clean image") {
             steps {
                 script {
        	        echo 'Clean image'
           	        sh 'docker rmi $imagename'
                 }
             }
        }

	}
}